name: Controle Qualite Roulotte Solidaire

on:
  pull_request:
    branches: [ "main" ]

jobs:
  controle-qualite:
    name: V√©rification des fichiers
    runs-on: windows-latest

    steps:
      - name: R√©cup√©ration du d√©p√¥t
        uses: actions/checkout@v3

      - name: Liste des fichiers modifi√©s
        id: fichiers
        run: |
          echo "files=$(jq -r '.pull_request.head.sha' $GITHUB_EVENT_PATH)" >> $GITHUB_OUTPUT

      - name: V√©rification du nommage des fichiers
        run: |
          echo "üîç V√©rification du nommage..."
          erreurs=0
          for f in $(git diff --name-only HEAD~1); do
            if [[ "$f" =~ ^(photos|videos)/.*\.(jpg|jpeg|png|mp4)$ ]]; then
              if ! [[ "$f" =~ (photo|video)_[0-9]{4}-[0-9]{2}-[0-9]{2}_[A-Za-z0-9-]+_[a-z0-9-]+\.(jpg|jpeg|png|mp4)$ ]]; then
                echo "‚ùå Mauvais nommage : $f"
                erreurs=1
              fi
            fi
          done
          if [ $erreurs -eq 1 ]; then
            exit 1
          fi
          echo "‚úîÔ∏è Nommage correct"

      - name: V√©rification de la taille des fichiers
        run: |
          echo "üîç V√©rification de la taille..."
          for f in $(git diff --name-only HEAD~1); do
            if [[ -f "$f" ]]; then
              size=$(stat -c%s "$f")
              if [ $size -gt 200000000 ]; then
                echo "‚ùå Fichier trop volumineux (>200 Mo) : $f"
                exit 1
              fi
            fi
          done
          echo "‚úîÔ∏è Taille des fichiers OK"

      - name: V√©rification des extensions autoris√©es
        run: |
          echo "üîç V√©rification des extensions..."
          for f in $(git diff --name-only HEAD~1); do
            if [[ "$f" =~ \.(exe|zip|rar|7z|pdf|docx)$ ]]; then
              echo "‚ùå Extension interdite : $f"
              exit 1
            fi
          done
          echo "‚úîÔ∏è Extensions conformes"

      - name: V√©rification des descriptions
        run: |
          echo "üîç V√©rification des descriptions..."
          erreurs=0
          for f in $(git diff --name-only HEAD~1); do
            if [[ "$f" =~ ^(photos|videos)/ ]]; then
              dossier=$(dirname "$f")
              if [ ! -f "$dossier/DESCRIPTION.md" ]; then
                echo "‚ùå Pas de DESCRIPTION.md pour : $dossier"
                erreurs=1
              fi
            fi
          done
          if [ $erreurs -eq 1 ]; then
            exit 1
          fi
          echo "‚úîÔ∏è Descriptions pr√©sentes"

      - name: V√©rification de contenu sensible (mots-cl√©s)
        run: |
          echo "üîç V√©rification de contenu sensible..."
          mots_interdits="nom|adresse|num√©ro|carte|papiers|sant√©|maladie|asile|dossier"
          for f in $(git diff --name-only HEAD~1); do
            if [[ "$f" =~ \.(md|txt)$ ]]; then
              if grep -Ei "$mots_interdits" "$f"; then
                echo "‚ùå Contenu sensible d√©tect√© dans : $f"
                exit 1
              fi
            fi
          done
          echo "‚úîÔ∏è Aucun contenu sensible d√©tect√©"

      - name: R√©sultat final
        run: echo "üéâ Toutes les v√©rifications sont pass√©es avec succ√®s !"
